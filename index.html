<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>YandelAi ‚Äì Meet Assistant</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <script src="https://www.gstatic.com/meetjs/addons/1.1.0/meet.addons.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        'primary-dark': '#4f46e5',
                        'primary-light': '#818cf8',
                    }
                }
            }
        }
    </script>
    <style>
    <style>
        @keyframes pulse-slow {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        @keyframes slide-up {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-up {
            animation: slide-up 0.4s ease-out;
        }

        .pulse-slow {
            animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .glassmorphism {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 min-h-screen">
<div class="p-4 max-w-md mx-auto">
    <!-- Header -->
    <div class="mb-6 animate-slide-up">
        <div class="flex items-center gap-3 mb-3">
            <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 flex items-center justify-center shadow-lg shadow-indigo-500/30">
                <span class="text-2xl font-bold text-white">Y</span>
            </div>
            <div>
                <h1 class="text-xl font-bold text-slate-800">Yandel AI</h1>
                <p class="text-xs text-slate-500">Meet Assistant</p>
            </div>
        </div>
        <p class="text-sm text-slate-600 leading-relaxed">
            AI-powered assistant that transcribes, analyzes and summarizes your meetings in real-time.
        </p>
    </div>

    <!-- Status Chips -->
    <div class="flex gap-2 mb-4 animate-slide-up" style="animation-delay: 0.1s;">
        <div class="inline-flex items-center gap-2 px-3 py-1.5 bg-emerald-50 border border-emerald-200 rounded-full">
            <div class="w-2 h-2 bg-emerald-500 rounded-full pulse-slow"></div>
            <span class="text-xs font-medium text-emerald-700">Live Transcription</span>
        </div>
        <div class="inline-flex items-center px-3 py-1.5 bg-blue-50 border border-blue-200 rounded-full">
            <span class="text-xs font-medium text-blue-700">Scrum Ready</span>
        </div>
    </div>

    <!-- Main Card -->
    <div class="glassmorphism rounded-2xl shadow-xl shadow-slate-200/50 border border-white/60 p-5 mb-4 animate-slide-up" style="animation-delay: 0.2s;">
        <label for="meetInput" class="block text-sm font-semibold text-slate-700 mb-2">
            Google Meet URL
        </label>
        <div class="relative mb-4">
            <input
                id="meetInput"
                type="text"
                placeholder="https://meet.google.com/xxx-xxxx-xxx"
                class="w-full px-4 py-3 bg-white border-2 border-slate-200 rounded-xl text-sm text-slate-800 placeholder-slate-400 focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all outline-none"
            />
            <div class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                </svg>
            </div>
        </div>

        <label for="requestedByInput" class="block text-sm font-semibold text-slate-700 mb-2">
            Your Email
        </label>
        <div class="relative">
            <input
                id="requestedByInput"
                type="email"
                placeholder="your-email@company.com"
                class="w-full px-4 py-3 bg-white border-2 border-slate-200 rounded-xl text-sm text-slate-800 placeholder-slate-400 focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all outline-none"
            />
            <div class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207" />
                </svg>
            </div>
        </div>

        <!-- Info Banner -->
        <div class="mt-4 p-3 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 rounded-xl">
            <div class="flex gap-2">
                <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
                <p class="text-xs text-blue-700 leading-relaxed">
                    YandelAi will automatically join, transcribe and generate summaries with action items for your team.
                </p>
            </div>
        </div>

        <!-- Start Button -->
        <button 
            id="startBtn"
            class="mt-4 w-full px-6 py-3.5 bg-gradient-to-r from-primary to-primary-dark hover:from-primary-dark hover:to-primary text-white font-semibold rounded-xl shadow-lg shadow-primary/30 hover:shadow-xl hover:shadow-primary/40 hover:-translate-y-0.5 active:translate-y-0 transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-60 disabled:cursor-not-allowed disabled:hover:translate-y-0"
        >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            <span>Start YandelAi</span>
        </button>

        <!-- Status Message -->
        <div id="status" class="mt-3 text-xs text-center min-h-4 transition-all"></div>
    </div>

    <!-- Transcript Card -->
    <div class="glassmorphism rounded-2xl shadow-xl shadow-slate-200/50 border border-white/60 p-5 animate-slide-up" style="animation-delay: 0.3s;">
        <div class="flex items-center justify-between mb-3">
            <div>
                <h3 class="text-sm font-semibold text-slate-800">Live Transcript</h3>
                <p class="text-xs text-slate-500">Real-time updates every few seconds</p>
            </div>
            <span id="phasePill" class="px-2.5 py-1 text-xs font-medium text-slate-600 bg-slate-100 rounded-full">
                Idle
            </span>
        </div>
        <div class="mt-3 p-4 bg-slate-50/50 rounded-xl border border-slate-100">
            <pre id="transcriptBox" class="text-xs text-slate-600 leading-relaxed whitespace-pre-wrap max-h-64 overflow-y-auto font-sans">No transcript yet. Start YandelAi and begin speaking in your Meet.</pre>
        </div>
    </div>
</div>

<script>
    const CLOUD_PROJECT_NUMBER = "91660774725";

    const BACKEND_URL = "https://played-patients-feedback-turns.trycloudflare.com";

    const btn = document.getElementById("startBtn");
    const input = document.getElementById("meetInput");
    const requestedByInput = document.getElementById("requestedByInput");
    const statusEl = document.getElementById("status");
    const transcriptBox = document.getElementById("transcriptBox");
    const phasePill = document.getElementById("phasePill");

    let lastTranscript = "";
    let meetSession = null;
    let sidePanelClient = null;

    function setStatus(message, type = "normal") {
        statusEl.textContent = message || "";
        statusEl.className = "mt-3 text-xs text-center min-h-4 transition-all font-medium";
        if (type === "ok") statusEl.className += " text-emerald-600";
        else if (type === "error") statusEl.className += " text-rose-600";
        else statusEl.className += " text-slate-500";
    }

    function setPhase(phase) {
        if (!phase) {
            phasePill.textContent = "Idle";
            phasePill.className = "px-2.5 py-1 text-xs font-medium text-slate-600 bg-slate-100 rounded-full";
            return;
        }
        phasePill.textContent = phase;
        phasePill.className = "px-2.5 py-1 text-xs font-medium text-primary bg-primary/10 rounded-full";
    }

    function renderTranscript(text) {
        if (!text || !text.trim()) {
            transcriptBox.textContent = "No transcript yet. Start YandelAi and begin speaking in your Meet.";
            transcriptBox.className = "text-xs text-slate-400 italic leading-relaxed whitespace-pre-wrap max-h-64 overflow-y-auto font-sans";
            return;
        }
        transcriptBox.className = "text-xs text-slate-700 leading-relaxed whitespace-pre-wrap max-h-64 overflow-y-auto font-sans";
        transcriptBox.textContent = text.trim();
    }

    async function initMeetAddon() {
        try {
            console.log("üöÄ [DEBUG] Checking for Meet SDK...");
            console.log("üöÄ [DEBUG] window.meet exists:", !!window.meet);
            console.log("üöÄ [DEBUG] window.meet.addon exists:", !!(window.meet && window.meet.addon));
            console.log("üöÄ [DEBUG] createAddonSession exists:", !!(window.meet && window.meet.addon && window.meet.addon.createAddonSession));

            if (!window.meet || !window.meet.addon || !window.meet.addon.createAddonSession) {
                console.warn("‚ö†Ô∏è Meet Add-ons SDK not found. Probably running outside Meet.");
                setStatus("‚ö†Ô∏è Running outside Google Meet. Enter URL manually.", "normal");
                return;
            }

            console.log("‚úÖ [DEBUG] Meet SDK found. Creating addon session...");
            
            // 1. Crear la sesi√≥n del add-on (handshake con Meet)
            meetSession = await window.meet.addon.createAddonSession({
                cloudProjectNumber: CLOUD_PROJECT_NUMBER,
            });
            console.log("‚úÖ [DEBUG] Addon session created:", meetSession);

            // 2. Crear el Side Panel Client
            sidePanelClient = await meetSession.createSidePanelClient();
            console.log("‚úÖ [DEBUG] Side panel client created:", sidePanelClient);
            console.log("‚úÖ [DEBUG] Available methods:", Object.keys(sidePanelClient));

            // 3. Obtener informaci√≥n de la reuni√≥n actual (URL, c√≥digo, etc.)
            try {
                console.log("üîç [DEBUG] Fetching meeting info...");
                const meetingInfo = await sidePanelClient.getMeetingInfo();
                console.log("üìä [DEBUG] Meeting info received:", JSON.stringify(meetingInfo, null, 2));
                console.log("üìä [DEBUG] Meeting info keys:", Object.keys(meetingInfo || {}));
                console.log("üìä [DEBUG] meetingUrl:", meetingInfo?.meetingUrl);
                console.log("üìä [DEBUG] meetingCode:", meetingInfo?.meetingCode);
                console.log("üìä [DEBUG] meetingId:", meetingInfo?.meetingId);
                
                // Try different possible property names for URL
                let meetUrl = meetingInfo?.meetingUrl || meetingInfo?.url || meetingInfo?.meetUrl || meetingInfo?.link;
                
                // If no direct URL but we have meetingCode, construct the URL
                if (!meetUrl && meetingInfo?.meetingCode) {
                    meetUrl = `https://meet.google.com/${meetingInfo.meetingCode}`;
                    console.log("üîß [DEBUG] Constructed URL from meetingCode:", meetUrl);
                }
                
                console.log("üîç [DEBUG] Final URL:", meetUrl);

                if (meetUrl && input) {
                    input.value = meetUrl;
                    setStatus("‚úÖ Meeting URL detected from Google Meet.", "ok");
                    console.log("‚úÖ [DEBUG] URL set to input field:", meetUrl);
                } else {
                    setStatus("Enter a Meet URL or start the call first.", "normal");
                    console.warn("‚ö†Ô∏è [DEBUG] No URL or meeting code found in meeting info");
                }
            } catch (err) {
                console.error("‚ùå [DEBUG] Error fetching meeting info:", err);
                console.error("‚ùå [DEBUG] Error stack:", err.stack);
                console.error("‚ùå [DEBUG] Error name:", err.name);
                console.error("‚ùå [DEBUG] Error message:", err.message);
                setStatus("Add-on session ready. Enter a Meet URL.", "normal");
            }

            // 4. Intentar obtener informaci√≥n adicional de la reuni√≥n (participantes, t√≠tulo, etc.)
            try {
                console.log("üîç [DEBUG] Attempting to get additional meeting metadata...");
                
                // Check if getParticipants method exists
                if (typeof sidePanelClient.getParticipants === 'function') {
                    const participants = await sidePanelClient.getParticipants();
                    console.log("üë• [DEBUG] Participants:", participants);
                } else {
                    console.warn("‚ö†Ô∏è [DEBUG] getParticipants method not available");
                }

                // Check if getActivity method exists
                if (typeof sidePanelClient.getActivity === 'function') {
                    const activity = await sidePanelClient.getActivity();
                    console.log("üéØ [DEBUG] Activity info:", activity);
                } else {
                    console.warn("‚ö†Ô∏è [DEBUG] getActivity method not available");
                }

                // Try to get meeting metadata from session
                if (meetSession.getMeetingInfo && typeof meetSession.getMeetingInfo === 'function') {
                    const sessionInfo = await meetSession.getMeetingInfo();
                    console.log("üìã [DEBUG] Session meeting info:", sessionInfo);
                }

                // Log all available methods on sidePanelClient
                console.log("üìã [DEBUG] All sidePanelClient methods:");
                for (const method in sidePanelClient) {
                    if (typeof sidePanelClient[method] === 'function') {
                        console.log(`   - ${method}()`);
                    }
                }

            } catch (err) {
                console.warn("‚ö†Ô∏è [DEBUG] Could not fetch additional metadata:", err.message);
            }

        } catch (err) {
            console.error("‚ùå [DEBUG] Error initializing Meet Add-on session:", err);
            console.error("‚ùå [DEBUG] Error details:", {
                name: err.name,
                message: err.message,
                stack: err.stack
            });
            setStatus("Could not initialize Meet add-on session.", "error");
        }
    }

    async function startBot() {
        const url = input.value.trim();
        const requestedBy = requestedByInput.value.trim();

        console.log("üöÄ [DEBUG] startBot() called with URL:", url);
        console.log("üöÄ [DEBUG] requestedBy:", requestedBy);

        if (!url.startsWith("https://meet.google.com")) {
            setStatus("‚ùå Enter a valid Meet URL", "error");
            console.warn("‚ö†Ô∏è [DEBUG] Invalid Meet URL format");
            return;
        }

        if (!requestedBy || !requestedBy.includes("@")) {
            setStatus("‚ùå Enter a valid email address", "error");
            console.warn("‚ö†Ô∏è [DEBUG] Invalid or missing email");
            return;
        }

        if (!BACKEND_URL || BACKEND_URL.startsWith("https://TU-BACKEND")) {
            setStatus("‚ö†Ô∏è BACKEND_URL is not configured in the panel.", "error");
            console.error("‚ùå [DEBUG] BACKEND_URL not configured");
            return;
        }

        setStatus("üöÄ Starting YandelAi...", "normal");
        btn.disabled = true;

        try {
            const payload = { 
                meetUrl: url,
                requestedBy: requestedBy
            };

            console.log("üì§ [DEBUG] Sending payload to backend:", JSON.stringify(payload, null, 2));
            console.log("üì§ [DEBUG] Backend URL:", `${BACKEND_URL}/api/start-meet-bot`);

            const res = await fetch(`${BACKEND_URL}/api/start-meet-bot`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(payload)
            });

            console.log("üì• [DEBUG] Response status:", res.status, res.statusText);

            const data = await res.json().catch(() => ({}));
            console.log("üì• [DEBUG] Response data:", data);

            if (res.ok) {
                setStatus("‚úÖ YandelAi is joining the meeting...", "ok");
                console.log("‚úÖ [DEBUG] Bot started successfully");
            } else {
                setStatus("‚ö†Ô∏è " + (data.error || "Unknown error"), "error");
                console.error("‚ùå [DEBUG] Backend error:", data);
                btn.disabled = false;
            }
        } catch (err) {
            setStatus("‚ùå Network error: " + err, "error");
            console.error("‚ùå [DEBUG] Network/fetch error:", err);
            console.error("‚ùå [DEBUG] Error details:", {
                name: err.name,
                message: err.message,
                stack: err.stack
            });
            btn.disabled = false;
        }
    }

    async function refreshStatus() {
        if (!BACKEND_URL || BACKEND_URL.startsWith("https://TU-BACKEND")) {
            return;
        }
        try {
            const res = await fetch(`${BACKEND_URL}/api/bot-status`);
            if (!res.ok) return;
            const data = await res.json();

            if (data.message) {
                setStatus(data.message);
            } else if (data.phase) {
                setStatus("Phase: " + data.phase);
            }

            if (data.phase) {
                setPhase(data.phase);
            }

            if (typeof data.transcript === "string" && data.transcript !== lastTranscript) {
                lastTranscript = data.transcript;
                renderTranscript(lastTranscript);
            }
        } catch (err) {
        }
    }

    btn.addEventListener("click", startBot);


    window.addEventListener("load", () => {
        console.log("üé¨ [DEBUG] Page loaded. Starting initialization...");
        console.log("üé¨ [DEBUG] User agent:", navigator.userAgent);
        console.log("üé¨ [DEBUG] Location:", window.location.href);
        
        initMeetAddon();
        
        console.log("‚è∞ [DEBUG] Starting status polling every 5 seconds...");
        setInterval(refreshStatus, 5000);
        refreshStatus();
    });
</script>
</body>
</html>
