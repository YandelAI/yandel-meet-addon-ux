<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>YandelIA ‚Äì Meet Assistant</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <script src="https://www.gstatic.com/meetjs/addons/1.1.0/meet.addons.js"></script>
    <style>
        :root {
            --primary: #1a73e8;
            --primary-soft: rgba(26, 115, 232, 0.08);
            --bg: #ffffff;
            --text-main: #202124;
            --text-muted: #5f6368;
            --border: #dadce0;
            --success: #188038;
            --danger: #d93025;
            --chip-bg: #e8f0fe;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 16px;
            background: var(--bg);
            color: var(--text-main);
        }

        header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .logo-circle {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff, #1a73e8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            color: #fff;
        }

        h1 {
            font-size: 18px;
            margin: 0;
        }

        .subtitle {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .chip-row {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .chip {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 999px;
            border: 1px solid var(--border);
            color: var(--text-muted);
            background: #fafafa;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .chip.live {
            border-color: var(--success);
            color: var(--success);
            background: #e6f4ea;
        }

        .chip-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 1.2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.5);
                opacity: 0.4;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .field {
            margin-top: 10px;
            margin-bottom: 8px;
        }

        label {
            font-size: 12px;
            color: var(--text-muted);
            display: block;
            margin-bottom: 4px;
        }

        input {
            width: 100%;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            font-size: 13px;
            outline: none;
        }

        input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 1px var(--primary-soft);
        }

        button {
            margin-top: 10px;
            padding: 9px 14px;
            width: 100%;
            border-radius: 6px;
            border: none;
            background: var(--primary);
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        button:disabled {
            opacity: 0.7;
            cursor: default;
        }

        .status {
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-muted);
            min-height: 16px;
        }

        .status.ok {
            color: var(--success);
        }

        .status.error {
            color: var(--danger);
        }

        .card {
            margin-top: 14px;
            border-radius: 10px;
            border: 1px solid var(--border);
            padding: 10px 10px 8px;
            background: #fafafa;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .card-title {
            font-size: 13px;
            font-weight: 600;
        }

        .card-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        .pill {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            background: var(--chip-bg);
            color: var(--primary);
        }

        #transcriptBox {
            white-space: pre-wrap;
            font-size: 12px;
            line-height: 1.45;
            max-height: 260px;
            overflow-y: auto;
            padding-right: 2px;
        }

        .empty-transcript {
            font-size: 12px;
            color: var(--text-muted);
            font-style: italic;
        }

        .collapsible-section {
            margin-top: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: #fafafa;
            cursor: pointer;
            user-select: none;
        }

        .collapsible-header:hover {
            background: #f1f3f4;
        }

        .collapsible-title {
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .collapsible-icon {
            transition: transform 0.2s;
            font-size: 16px;
        }

        .collapsible-icon.expanded {
            transform: rotate(90deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: white;
        }

        .collapsible-content.expanded {
            max-height: 600px;
        }

        .collapsible-inner {
            padding: 12px;
        }

        .field-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .field-full {
            grid-column: 1 / -1;
        }
    </style>
</head>
<body>
<header>
    <div class="logo-circle">Y</div>
    <div>
        <h1>Yandel AI Meet Assistant</h1>
        <div class="subtitle">Scrum-aware AI that listens, transcribes & summarizes your meeting.</div>
    </div>
</header>

<div class="chip-row">
    <div class="chip live">
        <span class="chip-dot"></span>
        Live transcript
    </div>
    <div class="chip">Scrum Daily / Retro / Planning</div>
</div>

<div class="field">
    <label for="meetInput">Google Meet URL</label>
    <input
            id="meetInput"
            placeholder="https://meet.google.com/xxx-xxxx-xxx"
    />
</div>

<div class="collapsible-section">
    <div class="collapsible-header" id="jiraToggle">
        <div class="collapsible-title">
            <span class="collapsible-icon">‚ñ∂</span>
            ‚öôÔ∏è Jira/Scrum Settings (optional)
        </div>
        <span style="font-size: 11px; color: var(--text-muted);">For auto-summary</span>
    </div>
    <div class="collapsible-content" id="jiraContent">
        <div class="collapsible-inner">
            <div class="field-grid">
                <div class="field-full">
                    <label for="requestedBy">Requested By (email)</label>
                    <input
                            id="requestedBy"
                            type="email"
                            placeholder="tu-correo@empresa.com"
                    />
                </div>
                <div>
                    <label for="projectId">Project ID</label>
                    <input
                            id="projectId"
                            placeholder="10000"
                    />
                </div>
                <div>
                    <label for="boardName">Board Name</label>
                    <input
                            id="boardName"
                            placeholder="Soporte QE"
                    />
                </div>
                <div>
                    <label for="projectName">Project Name</label>
                    <input
                            id="projectName"
                            placeholder="Scrum"
                    />
                </div>
                <div>
                    <label for="defaultEpic">Default Epic</label>
                    <input
                            id="defaultEpic"
                            placeholder="SCRUM-8"
                    />
                </div>
                <div class="field-full">
                    <label for="defaultAssignee">Default Assignee</label>
                    <input
                            id="defaultAssignee"
                            placeholder="Juan Perez"
                    />
                </div>
                <div class="field-full">
                    <label for="defaultReporter">Default Reporter</label>
                    <input
                            id="defaultReporter"
                            type="email"
                            placeholder="maria@empresa.com"
                    />
                </div>
            </div>
        </div>
    </div>
</div>

<button id="startBtn">
    <span>Start YandelIA in this meeting</span>
</button>

<div id="status" class="status"></div>

<div class="card">
    <div class="card-header">
        <div>
            <div class="card-title">Live transcript</div>
            <div class="card-meta">Updated every few seconds while the bot is in the call.</div>
        </div>
        <span class="pill" id="phasePill">Idle</span>
    </div>
    <pre id="transcriptBox" class="empty-transcript">
No transcript yet. Start YandelIA and begin speaking in your Meet.</pre>
</div>

<script>
    const CLOUD_PROJECT_NUMBER = "91660774725";

    const BACKEND_URL = "https://played-patients-feedback-turns.trycloudflare.com";

    const btn = document.getElementById("startBtn");
    const input = document.getElementById("meetInput");
    const statusEl = document.getElementById("status");
    const transcriptBox = document.getElementById("transcriptBox");
    const phasePill = document.getElementById("phasePill");

    // Jira/Scrum fields
    const requestedByInput = document.getElementById("requestedBy");
    const projectIdInput = document.getElementById("projectId");
    const boardNameInput = document.getElementById("boardName");
    const projectNameInput = document.getElementById("projectName");
    const defaultEpicInput = document.getElementById("defaultEpic");
    const defaultAssigneeInput = document.getElementById("defaultAssignee");
    const defaultReporterInput = document.getElementById("defaultReporter");

    let lastTranscript = "";
    let meetSession = null;
    let sidePanelClient = null;

    // Toggle collapsible section
    document.getElementById("jiraToggle").addEventListener("click", () => {
        const content = document.getElementById("jiraContent");
        const icon = document.querySelector(".collapsible-icon");
        content.classList.toggle("expanded");
        icon.classList.toggle("expanded");
    });

    function setStatus(message, type = "normal") {
        statusEl.textContent = message || "";
        statusEl.classList.remove("ok", "error");
        if (type === "ok") statusEl.classList.add("ok");
        if (type === "error") statusEl.classList.add("error");
    }

    function setPhase(phase) {
        if (!phase) {
            phasePill.textContent = "Idle";
            return;
        }
        phasePill.textContent = phase;
    }

    function renderTranscript(text) {
        if (!text || !text.trim()) {
            transcriptBox.textContent =
                "No transcript yet. Start YandelIA and begin speaking in your Meet.";
            transcriptBox.classList.add("empty-transcript");
            return;
        }
        transcriptBox.classList.remove("empty-transcript");
        transcriptBox.textContent = text.trim();
    }

    async function initMeetAddon() {
        try {
            console.log("üöÄ [DEBUG] Checking for Meet SDK...");
            console.log("üöÄ [DEBUG] window.meet exists:", !!window.meet);
            console.log("üöÄ [DEBUG] window.meet.addon exists:", !!(window.meet && window.meet.addon));
            console.log("üöÄ [DEBUG] createAddonSession exists:", !!(window.meet && window.meet.addon && window.meet.addon.createAddonSession));

            if (!window.meet || !window.meet.addon || !window.meet.addon.createAddonSession) {
                console.warn("‚ö†Ô∏è Meet Add-ons SDK not found. Probably running outside Meet.");
                setStatus("‚ö†Ô∏è Running outside Google Meet. Enter URL manually.", "normal");
                return;
            }

            console.log("‚úÖ [DEBUG] Meet SDK found. Creating addon session...");
            
            // 1. Crear la sesi√≥n del add-on (handshake con Meet)
            meetSession = await window.meet.addon.createAddonSession({
                cloudProjectNumber: CLOUD_PROJECT_NUMBER,
            });
            console.log("‚úÖ [DEBUG] Addon session created:", meetSession);

            // 2. Crear el Side Panel Client
            sidePanelClient = await meetSession.createSidePanelClient();
            console.log("‚úÖ [DEBUG] Side panel client created:", sidePanelClient);
            console.log("‚úÖ [DEBUG] Available methods:", Object.keys(sidePanelClient));

            // 3. Obtener informaci√≥n de la reuni√≥n actual (URL, c√≥digo, etc.)
            try {
                console.log("üîç [DEBUG] Fetching meeting info...");
                const meetingInfo = await sidePanelClient.getMeetingInfo();
                console.log("üìä [DEBUG] Meeting info received:", JSON.stringify(meetingInfo, null, 2));
                console.log("üìä [DEBUG] Meeting info keys:", Object.keys(meetingInfo || {}));
                console.log("üìä [DEBUG] meetingUrl:", meetingInfo?.meetingUrl);
                console.log("üìä [DEBUG] meetingCode:", meetingInfo?.meetingCode);
                console.log("üìä [DEBUG] meetingId:", meetingInfo?.meetingId);
                
                // Try different possible property names for URL
                let meetUrl = meetingInfo?.meetingUrl || meetingInfo?.url || meetingInfo?.meetUrl || meetingInfo?.link;
                
                // If no direct URL but we have meetingCode, construct the URL
                if (!meetUrl && meetingInfo?.meetingCode) {
                    meetUrl = `https://meet.google.com/${meetingInfo.meetingCode}`;
                    console.log("üîß [DEBUG] Constructed URL from meetingCode:", meetUrl);
                }
                
                console.log("üîç [DEBUG] Final URL:", meetUrl);

                if (meetUrl && input) {
                    input.value = meetUrl;
                    setStatus("‚úÖ Meeting URL detected from Google Meet.", "ok");
                    console.log("‚úÖ [DEBUG] URL set to input field:", meetUrl);
                } else {
                    setStatus("Enter a Meet URL or start the call first.", "normal");
                    console.warn("‚ö†Ô∏è [DEBUG] No URL or meeting code found in meeting info");
                }
            } catch (err) {
                console.error("‚ùå [DEBUG] Error fetching meeting info:", err);
                console.error("‚ùå [DEBUG] Error stack:", err.stack);
                console.error("‚ùå [DEBUG] Error name:", err.name);
                console.error("‚ùå [DEBUG] Error message:", err.message);
                setStatus("Add-on session ready. Enter a Meet URL.", "normal");
            }

            // 4. Intentar obtener informaci√≥n adicional de la reuni√≥n (participantes, t√≠tulo, etc.)
            try {
                console.log("üîç [DEBUG] Attempting to get additional meeting metadata...");
                
                // Check if getParticipants method exists
                if (typeof sidePanelClient.getParticipants === 'function') {
                    const participants = await sidePanelClient.getParticipants();
                    console.log("üë• [DEBUG] Participants:", participants);
                } else {
                    console.warn("‚ö†Ô∏è [DEBUG] getParticipants method not available");
                }

                // Check if getActivity method exists
                if (typeof sidePanelClient.getActivity === 'function') {
                    const activity = await sidePanelClient.getActivity();
                    console.log("üéØ [DEBUG] Activity info:", activity);
                } else {
                    console.warn("‚ö†Ô∏è [DEBUG] getActivity method not available");
                }

                // Try to get meeting metadata from session
                if (meetSession.getMeetingInfo && typeof meetSession.getMeetingInfo === 'function') {
                    const sessionInfo = await meetSession.getMeetingInfo();
                    console.log("üìã [DEBUG] Session meeting info:", sessionInfo);
                }

                // Log all available methods on sidePanelClient
                console.log("üìã [DEBUG] All sidePanelClient methods:");
                for (const method in sidePanelClient) {
                    if (typeof sidePanelClient[method] === 'function') {
                        console.log(`   - ${method}()`);
                    }
                }

            } catch (err) {
                console.warn("‚ö†Ô∏è [DEBUG] Could not fetch additional metadata:", err.message);
            }

        } catch (err) {
            console.error("‚ùå [DEBUG] Error initializing Meet Add-on session:", err);
            console.error("‚ùå [DEBUG] Error details:", {
                name: err.name,
                message: err.message,
                stack: err.stack
            });
            setStatus("Could not initialize Meet add-on session.", "error");
        }
    }

    async function startBot() {
        const url = input.value.trim();

        console.log("üöÄ [DEBUG] startBot() called with URL:", url);

        if (!url.startsWith("https://meet.google.com")) {
            setStatus("‚ùå Enter a valid Meet URL", "error");
            console.warn("‚ö†Ô∏è [DEBUG] Invalid Meet URL format");
            return;
        }

        if (!BACKEND_URL || BACKEND_URL.startsWith("https://TU-BACKEND")) {
            setStatus("‚ö†Ô∏è BACKEND_URL is not configured in the panel.", "error");
            console.error("‚ùå [DEBUG] BACKEND_URL not configured");
            return;
        }

        setStatus("üöÄ Starting YandelIA...", "normal");
        btn.disabled = true;

        try {
            // Build payload with optional fields
            const payload = {
                meetUrl: url
            };

            // Add optional Jira/Scrum fields if provided
            const requestedBy = requestedByInput.value.trim();
            const projectId = projectIdInput.value.trim();
            const boardName = boardNameInput.value.trim();
            const projectName = projectNameInput.value.trim();
            const defaultEpic = defaultEpicInput.value.trim();
            const defaultAssignee = defaultAssigneeInput.value.trim();
            const defaultReporter = defaultReporterInput.value.trim();

            if (requestedBy) payload.requestedBy = requestedBy;
            if (projectId) payload.project_id = projectId;
            if (boardName) payload.board_name = boardName;
            if (projectName) payload.project_name = projectName;
            if (defaultEpic) payload.default_epic = defaultEpic;
            if (defaultAssignee) payload.default_assignee = defaultAssignee;
            if (defaultReporter) payload.default_reporter = defaultReporter;

            console.log("üì§ [DEBUG] Sending payload to backend:", JSON.stringify(payload, null, 2));
            console.log("üì§ [DEBUG] Backend URL:", `${BACKEND_URL}/api/start-meet-bot`);

            const res = await fetch(`${BACKEND_URL}/api/start-meet-bot`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(payload)
            });

            console.log("üì• [DEBUG] Response status:", res.status, res.statusText);

            const data = await res.json().catch(() => ({}));
            console.log("üì• [DEBUG] Response data:", data);

            if (res.ok) {
                setStatus("‚úÖ YandelIA is joining the meeting...", "ok");
                console.log("‚úÖ [DEBUG] Bot started successfully");
            } else {
                setStatus("‚ö†Ô∏è " + (data.error || "Unknown error"), "error");
                console.error("‚ùå [DEBUG] Backend error:", data);
                btn.disabled = false;
            }
        } catch (err) {
            setStatus("‚ùå Network error: " + err, "error");
            console.error("‚ùå [DEBUG] Network/fetch error:", err);
            console.error("‚ùå [DEBUG] Error details:", {
                name: err.name,
                message: err.message,
                stack: err.stack
            });
            btn.disabled = false;
        }
    }

    async function refreshStatus() {
        if (!BACKEND_URL || BACKEND_URL.startsWith("https://TU-BACKEND")) {
            return;
        }
        try {
            const res = await fetch(`${BACKEND_URL}/api/bot-status`);
            if (!res.ok) return;
            const data = await res.json();

            if (data.message) {
                setStatus(data.message);
            } else if (data.phase) {
                setStatus("Phase: " + data.phase);
            }

            if (data.phase) {
                setPhase(data.phase);
            }

            if (typeof data.transcript === "string" && data.transcript !== lastTranscript) {
                lastTranscript = data.transcript;
                renderTranscript(lastTranscript);
            }
        } catch (err) {
            // Ignorar errores de polling silenciosamente
        }
    }

    btn.addEventListener("click", startBot);

    // Al cargar la p√°gina en el side panel:
    // 1) Inicializamos el SDK de Meet (handshake, meeting info),
    // 2) Empezamos el polling de estado del bot.
    window.addEventListener("load", () => {
        console.log("üé¨ [DEBUG] Page loaded. Starting initialization...");
        console.log("üé¨ [DEBUG] User agent:", navigator.userAgent);
        console.log("üé¨ [DEBUG] Location:", window.location.href);
        
        initMeetAddon();
        
        console.log("‚è∞ [DEBUG] Starting status polling every 5 seconds...");
        setInterval(refreshStatus, 5000);
        refreshStatus();
    });
</script>
</body>
</html>
